---
title: ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Šäº‹ä»¶å¾ªç¯å’ŒPromise
toc: true
date: 2020-12-13 22:03:00
author: è€å•
excerpt: ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Šäº‹ä»¶å¾ªç¯å’ŒPromise
cover: 2020/12/13/ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Šäº‹ä»¶å¾ªç¯å’ŒPromise/cover.jpg
thumbnail: 2020/12/13/ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Šäº‹ä»¶å¾ªç¯å’ŒPromise/cover.jpg
categories:
  - [Promise, async/await, event-loop]
tags:
  - Promise, async/await, event-loop
---

æœ¬æ–‡æ˜¯åœ¨åŸæ–‡ç¿»è¯‘çš„åŸºç¡€ä¸Šè¿›è¡Œäº†éƒ¨åˆ†åˆ å‡å’Œè¡¥å……å†…å®¹ã€‚è‹¥æœ‰é—®é¢˜è¯·å¤šå¤šæŒ‡æ­£ï¼
åŸæ–‡é“¾æ¥ï¼š 1.<https://dev.to/lydiahallie/javascript-visualized-event-loop-3dif> 2.<https://dev.to/lydiahallie/javascript-visualized-promises-async-await-5gke>

# ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Šäº‹ä»¶å¾ªç¯

ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼Ÿ
é¦–å…ˆè®©æˆ‘ä»¬æ¥äº†è§£ä¸‹ JavaScript çš„å•çº¿ç¨‹ç‰¹æ€§ï¼šä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªä»»åŠ¡ã€‚å•çº¿ç¨‹çš„ç¨‹åºæ‰§è¡Œåˆ°äº†éœ€è¦å¼‚æ­¥çš„æ“ä½œï¼Œå°±ä¼šéœ€è¦ç­‰å¾…ã€‚è¿™æ—¶ç¨‹åºå°±ä¼šåœä¸‹ï¼Œåé¢çš„ä»£ç å°±ä¸ä¼šæ‰§è¡Œï¼Œå°±ä¼šé˜»å¡ç¨‹åº ğŸ˜¬

å¹¸è¿çš„æ˜¯ï¼Œæµè§ˆå™¨ä¸ºæˆ‘ä»¬æä¾›äº† JavaScript å¼•æ“è‡ªèº«éƒ½æ²¡æœ‰çš„ç‰¹æ€§â€”â€” `Web API` ã€‚å®ƒåŒ…å« DOM API ã€setTimeout ã€HTTP è¯·æ±‚ç­‰ç­‰ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºä¸€äº›å¼‚æ­¥çš„ã€éé˜»å¡çš„è¡Œä¸ºã€‚

å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šè¢«æ·»åŠ åˆ°æ‰§è¡Œæ ˆä¸­ã€‚æ‰§è¡Œæ ˆæ˜¯ JavaScript å¼•æ“çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸æ˜¯æµè§ˆå™¨çš„ç‰¹æ€§ã€‚å®ƒæ˜¯ä¸€ä¸ªå…ˆè¿›åå‡ºçš„æ ˆã€‚å½“ä¸€ä¸ªå‡½æ•°è¿”å›äº†ä¸€ä¸ªå€¼ï¼Œå°±æ˜¯å‡ºæ ˆã€‚ğŸ‘‹
1ï¼‰å½“å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå‡½æ•°ä¼šè¢«å‹å…¥æ‰§è¡Œæ ˆä¸­ï¼›å½“å‡½æ•°è¿”å›ä¸€ä¸ªå€¼çš„æ—¶å€™ï¼Œä¼šè¢«ç§»å‡ºæ‰§è¡Œæ ˆã€‚

{% asset_img event-loop1.gif %}

å›¾ä¸­çš„ respond å‡½æ•°è¿”å›äº†ä¸€ä¸ª Web API æä¾›ç»™æˆ‘ä»¬çš„ setTimeout å‡½æ•°ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸æ‰“ç ´ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ã€‚æˆ‘ä»¬ä¼ é€’ç»™ setTimeout å‡½æ•°çš„å›è°ƒå‡½æ•° ()=> {return 'Hey'} è¢«æ·»åŠ åˆ°äº† Web API ä¸­ã€‚setTimeout å‡½æ•°å’Œ respond å‡½æ•°è¢«æŒ¨ä¸ªå„¿ç§»å‡ºå †æ ˆã€‚

2ï¼‰Web API ç›‘å¬ç€æˆ‘ä»¬ä¼ é€’çš„å›è°ƒã€‚

{% asset_img event-loop2.gif %}

åœ¨ Web API ä¸­ï¼Œè®¡æ—¶å™¨çš„è¿è¡Œæ—¶é—´ä¸º 1000msã€‚åœ¨ç­‰å¾…äº† 1000ms ä¹‹åï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å¹¶æ²¡æœ‰è¢«ç«‹å³æ·»åŠ åˆ°æ‰§è¡Œæ ˆä¸­ï¼Œè€Œæ˜¯è¢«é€åˆ°äº†é˜Ÿåˆ—ä¸­ã€‚

3ï¼‰å½“å®šæ—¶è®¡æ—¶ç»“æŸæ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°è¢«é€åˆ°äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚

{% asset_img event-loop3.gif %}

æ³¨æ„äº†ï¼è¿™æ„å‘³ç€å›è°ƒå‡½æ•°ä¸æ˜¯åœ¨ 1000ms åè¢«æ·»åŠ åˆ°æ‰§è¡Œæ ˆä¸­ã€‚å®ƒåªæ˜¯åœ¨ 1000ms åè¢«æ·»åŠ åˆ°äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚å‡½æ•°å¾—æ’ç€é˜Ÿï¼Œç­‰åˆ°è½®åˆ°å®ƒçš„æ—¶å€™æ‰èƒ½è¢«æ‰§è¡Œã€‚

ç°åœ¨äº‹ä»¶å¾ªç¯å®Œæˆä»»åŠ¡çš„æ—¶åˆ»åˆ°æ¥äº†â€”â€”å¦‚æœæ‰§è¡Œæ ˆä¸ºç©ºï¼Œå½“ä¹‹å‰æ‰€æœ‰è°ƒç”¨çš„å‡½æ•°éƒ½è¿”å›äº†å€¼å¹¶è¢«ç§»å‡ºæ‰§è¡Œæ ˆçš„æ—¶å€™ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±è¢«åŠ åˆ°æ‰§è¡Œæ ˆä¸­äº†ã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–å‡½æ•°è¢«è°ƒç”¨ï¼Œè¿™æ„å‘³ç€å½“å›è°ƒå‡½æ•°æˆä¸ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€é¡¹æ—¶ï¼Œæ‰§è¡Œæ ˆä¸ºç©ºã€‚

4ï¼‰äº‹ä»¶å¾ªç¯æœºåˆ¶ç›‘å¬ç€ä»»åŠ¡é˜Ÿåˆ—å’Œæ‰§è¡Œæ ˆã€‚è‹¥æ‰§è¡Œæ ˆä¸ºç©ºï¼Œåˆ™å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç§»å…¥åˆ°æ‰§è¡Œæ ˆä¸­ã€‚

{% asset_img event-loop4.gif %}

äº‹ä»¶å¾ªç¯çš„å¤§è‡´å°±æ˜¯è¿™ä¹ˆä¸ªæµç¨‹ã€‚å°è¯•ç€å»è®¡ç®—ä»¥ä¸‹ä¾‹å­ä¸­æ§åˆ¶å°çš„æ‰“å°ç»“æœå§ï¼š

```js
const foo = () => console.log("First");
const bar = () => setTimeout(() => console.log("Second"), 500);
const baz = () => console.log("Third");

bar();
foo();
baz();
```

è®©æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œè¿™æ®µä»£ç çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå§ï¼š

{% asset_img event-loop-eg.gif %}

1.æˆ‘ä»¬è°ƒç”¨äº† bar å‡½æ•°ï¼Œbar è¿”å›äº†ä¸€ä¸ª setTimeout å‡½æ•°ã€‚

2.æˆ‘ä»¬ä¼ é€’ç»™ setTimeout çš„å›è°ƒè¢«æ·»åŠ åˆ° Web API ä¸­ï¼ŒsetTimeout å‡½æ•°å’Œ bar è¢«ä»æ‰§è¡Œæ ˆä¸­å¼¹å‡ºã€‚

3.å®šæ—¶å™¨å¼€å§‹è®¡æ—¶ï¼ŒåŒæ—¶æ‰§è¡Œæ ˆä¸­ foo å‡½æ•°è¢«è°ƒç”¨å¹¶æ‰“å°äº† First ï¼Œfoo è¿”å›äº†å€¼ï¼ˆ undefined ï¼‰ï¼Œbaz å‡½æ•°è¢«è°ƒç”¨ï¼Œbar çš„å›è°ƒå‡½æ•°è¢«æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚

4.baz æ‰“å°äº† Third ï¼Œå¹¶è¿”å›å€¼ undefined ã€‚äº‹ä»¶å¾ªç¯æœºåˆ¶æ­¤æ—¶å‘ç°å½“å‰æ‰§è¡Œæ ˆä¸ºç©ºï¼Œç„¶åå°†å›è°ƒå‡½æ•°ç§»å…¥æ‰§è¡Œæ ˆä¸­ã€‚

5.å›è°ƒå‡½æ•°æ‰“å°äº† Second ã€‚

# ç”¨å¯è§†åŒ–çš„æ–¹å¼è§£é‡Š promise å’Œ async-await

å½“æˆ‘ä»¬åœ¨å†™ JavaScript è„šæœ¬æ—¶ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°è¿™ä¹ˆä¸€ç§æƒ…å†µï¼šå¤„ç†ä¾èµ–å…¶ä»–ä»»åŠ¡çš„ä»»åŠ¡ï¼å‡è®¾æˆ‘ä»¬æƒ³è¦è·å¾—ä¸€å¹…å›¾åƒï¼Œå‹ç¼©å®ƒï¼Œåº”ç”¨è¿‡æ»¤å™¨å¹¶ä¿å­˜å®ƒ ğŸ“¸
æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œæ˜¯è·å¾—æˆ‘ä»¬æƒ³è¦å»ç¼–è¾‘çš„é‚£å¼ å›¾ç‰‡ã€‚ä¸€ä¸ª`getImage`å‡½æ•°å¯ä»¥åšåˆ°ã€‚åªæœ‰å½“è¯¥å›¾åƒæˆåŠŸåŠ è½½åï¼Œæˆ‘ä»¬æ‰èƒ½å°†è¯¥å€¼ä¼ é€’ç»™`resizeImage`å‡½æ•°ã€‚å½“å›¾åƒå¤§å°æˆåŠŸè°ƒæ•´åï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨`applyFilter`å‡½æ•°ä¸­å¯¹å›¾åƒåº”ç”¨ä¸€ä¸ªè¿‡æ»¤å™¨ã€‚åœ¨å›¾åƒè¢«å‹ç¼©å¹¶ä¸”å·²ç»æ·»åŠ äº†ä¸€ä¸ªè¿‡æ»¤å™¨ä¹‹åï¼Œæˆ‘ä»¬æƒ³è¦ä¿å­˜å›¾åƒå¹¶è®©ç”¨æˆ·çŸ¥é“ä¸€åˆ‡å·¥ä½œæ­£å¸¸ï¼ğŸ¥³ æœ€åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š

{% asset_img code1.png %}

em......è™½ç„¶è¿™ä¹ˆå†™æ²¡æ¯›ç—…ï¼Œä½†æˆ‘ä»¬ä¼šå¾—åˆ°è®¸å¤šåµŒå¥—çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬ä¾èµ–äºå‰é¢çš„å›è°ƒå‡½æ•°ã€‚è¿™é€šå¸¸è¢«ç§°ä¸º**å›è°ƒåœ°ç‹±**â€”â€”æˆ‘ä»¬ä½¿ç”¨äº† n å¤šä¸ªåµŒå¥—çš„å›è°ƒå‡½æ•°ã€‚è¿™ä½¿å¾—ä»£ç å˜å¾—éš¾ä»¥é˜…è¯»äº†ï¼ å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`Promise`æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼è®©æˆ‘ä»¬æ¥çœ‹çœ‹`Promise`æ˜¯ä»€ä¹ˆï¼Œä»¥åŠåœ¨è¿™ç§æƒ…å†µä¸‹å®ƒä»¬æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬çš„ï¼ğŸ˜ƒ

# Promise è¯­æ³•

ES6 å¼•è¿›äº†`Promise`ã€‚åœ¨ä½¿ç”¨ svn æ—¶ï¼Œä½ ä¼šçœ‹åˆ°è¿™æ ·çš„è¯ï¼š

> â€œ promise æ˜¯ä¸€ä¸ªå€¼çš„å ä½ç¬¦ï¼Œå®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ» resolve æˆ–è€… reject ã€‚â€

è¿™ä¸ªè§£é‡Šå¯¹äºæˆ‘ä»¬æ¥è¯´æ²¡é‚£ä¹ˆæ¸…æ™°ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹ Promise åˆ°åº•æ˜¯ä¸ªå•¥å§ï¼ æˆ‘ä»¬ä½¿ç”¨æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°çš„`Promise`æ„é€ å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª promise ã€‚

{% asset_img code2.gif %}

å“‡å“¦ï¼Œçœ‹çœ‹è¿™è¿”å›äº†å•¥ï¼Ÿ `Promise`æ˜¯ä¸€ä¸ªåŒ…å«çŠ¶æ€ï¼ˆ`[[PromiseStatus]]`ï¼‰å’Œä¸€ä¸ªå€¼ï¼ˆ`[[PromiseValue]]`ï¼‰çš„å¯¹è±¡ã€‚åœ¨ä¸Šä¾‹ä¸­ï¼Œä½ èƒ½çœ‹åˆ°`[[PromiseStatus]]`çš„å€¼æ˜¯ä¸€ä¸ª`"pending"`ï¼Œè€Œå€¼æ˜¯`undefined`ã€‚ ä¸è¦æ‹…å¿ƒï¼Œä½ æ°¸è¿œéƒ½ä¸éœ€è¦å…³å¿ƒè¯¥å¯¹è±¡ï¼Œç”šè‡³ä¸èƒ½è®¿é—®`[[PromiseStatus]]`å’Œ`[[PromiseValue]]`å±æ€§ã€‚ä¸ç®¡æ€æ ·ï¼Œè¿™ä¸¤ä¸ªæ˜¯ä½¿ç”¨ promise æ—¶ååˆ†é‡è¦çš„å±æ€§ã€‚ `PromiseStatus`çš„å€¼å¯èƒ½æ˜¯ä»¥ä¸‹ä¸‰ç§å€¼ï¼š

1. âœ… `fullfilled`ï¼špromise å·²ç»è¢«è§£æã€‚ä¸€åˆ‡æ­£å¸¸ï¼Œpromise å†…éƒ¨æ²¡æœ‰å‘ç”Ÿä»»ä½•é”™è¯¯ ğŸ¥³
2. âŒ`rejected`ï¼špromise å·²ç»è¢«æ‹’ç»ã€‚å‘ƒï¼Œä¹Ÿå°±æ˜¯é‡åˆ°äº†äº›é—®é¢˜ã€‚
3. â³`pending`ï¼špromise æ²¡æœ‰è§£æä¹Ÿæ²¡æœ‰æ‹’ç»ï¼Œpromise å¤„äºä¸€ä¸ªç­‰å¾…çŠ¶æ€ã€‚
   é‚£ä¹ˆ promise å•¥æ—¶å€™æ˜¯`fullfilled`ã€`rejected`æˆ–`pending`å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™äº›çŠ¶æ€å¾ˆé‡è¦å‘¢ï¼Ÿ
   åœ¨ä¸Šä¾‹ä¸­ï¼Œæˆ‘ä»¬åªè¦å°†ç®€å•çš„å›è°ƒå‡½æ•°`() => {}`ä¼ é€’ç»™`Promise`çš„æ„é€ å‡½æ•°ã€‚ç„¶è€Œè¿™ä¸ªå›è°ƒå‡½æ•°å®é™…ä¸Šæ”¶åˆ°äº†ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªå‚æ•°é€šå¸¸å«åš`resolve`æˆ–`res`ï¼ˆå³ä¸‹æ–‡æåˆ°çš„è§£æï¼‰ï¼Œå®ƒæ˜¯`Promise`åº”è¯¥è§£æçš„æ—¶å€™è°ƒç”¨çš„å‡½æ•°ã€‚ç¬¬äºŒä¸ªå‚æ•°çš„å€¼é€šå¸¸å«åš`reject`æˆ–`rej`ï¼ˆå³ä¸‹æ–‡æåˆ°çš„æ‹’ç»ï¼‰ï¼Œå®ƒæ˜¯`Promise`åº”è¯¥æ‹’ç»çš„æ—¶å€™ï¼ˆæœ‰å“ªäº›åœ°æ–¹å‡ºé”™æ—¶ï¼‰è°ƒç”¨çš„å‡½æ•°ã€‚
   {% asset_img code3.png %}
   è®©æˆ‘ä»¬æ¥çœ‹çœ‹å½“æˆ‘ä»¬è°ƒç”¨`resolve`æˆ–`reject`å‡½æ•°ä¼šæ‰“å°å‡ºä»€ä¹ˆå§~åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘è°ƒç”¨äº†è§£æå‡½æ•°`res`å’Œæ‹’ç»å‡½æ•°`rej`:
   {% asset_img code4.gif %}
   ä»ä¸Šå›¾çœ‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨`resolve`å‡½æ•°ï¼Œpromise çš„çŠ¶æ€å°±æ˜¯`fulfilled`ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨`rejected`å‡½æ•°ï¼Œpromise çš„çŠ¶æ€å°±æ˜¯`rejected`ã€‚
   promise çš„å€¼ï¼Œå³`[[PromiseValue]]`çš„å€¼ï¼Œæ˜¯`resolved`æˆ–`rejected`å‡½æ•°çš„ä¼ å‚ã€‚
   æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘è®© Jake Archibald æ ¡å¯¹äº†è¿™ç¯‡æ–‡ç« ï¼Œä»–æŒ‡å‡º Chrome æµè§ˆå™¨æœ‰ä¸ª bug ï¼Œå½“å‰æ˜¾ç¤ºçš„çŠ¶æ€æ˜¯`resolved`è€Œä¸æ˜¯`fullfilled`ã€‚ğŸ¥³ğŸ•º
   {% asset_img code5.png %}

> è¯‘è€…æ’ä¸€å˜´ï¼šè¿™ç¯‡æ–‡ç« ä¹Ÿè®¸å†å²æœ‰äº›ä¹…è¿œäº†ï¼Œæˆªè‡³ 2020.9.19 åœ¨è°·æ­Œçš„æ§åˆ¶å°æ‰“å°ç»“æœä¸º
> **proto**: Promise
> [[PromiseState]]: "fulfilled"
> [[PromiseResult]]: 123

ç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•æ›´å¥½åœ°æ§åˆ¶è¿™ä¸ª`Promise`å¯¹è±¡äº†ã€‚ä½†å®ƒæ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ
åœ¨ä»‹ç»éƒ¨åˆ†ä¸­ï¼Œæˆ‘å±•ç¤ºäº†ä¸€ä¸ªä¾‹å­ï¼Œåœ¨è¯¥ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è·å¾—ä¸€ä¸ªå›¾åƒï¼Œå¯¹å…¶è¿›è¡Œå‹ç¼©ï¼Œåº”ç”¨ä¸€ä¸ªæ–‡ä»¶å¤„ç†ç¨‹åºå¹¶ä¿å­˜å®ƒï¼æœ€ç»ˆï¼Œå½¢æˆäº†ä¸€ä¸ªåµŒå¥—çš„å›è°ƒä¹±è±¡ã€‚
å¹¸è¿çš„æ˜¯ï¼ŒPromise èƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬é‡å†™æ•´ä¸ªä»£ç å—ï¼Œä»¥ä¾¿æ¯ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª`Promise`ã€‚
å¦‚æœå›¾åƒå·²ç»åŠ è½½ï¼Œå¹¶ä¸”ä¸€åˆ‡æ­£å¸¸ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ç”¨å·²åŠ è½½çš„å›¾åƒæ¥è§£æ`promise`!å¦åˆ™ï¼Œå¦‚æœåœ¨åŠ è½½æ–‡ä»¶æ—¶æŸå¤„å‡ºç°é”™è¯¯ï¼Œæˆ‘ä»¬å°†æ‹’ç»åŒ…å«æ‰€å‘ç”Ÿé”™è¯¯çš„`promise`ã€‚
{% asset_img code7.png %}
è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿è¡Œå®ƒä¹‹åï¼Œç»ˆç«¯è¿”å›äº†ä»€ä¹ˆå§ï¼š
{% asset_img code8.gif %}
å¤ªé…·äº†ï¼æ­£å¦‚æˆ‘ä»¬æ‰€æœŸæœ›çš„é‚£æ ·ï¼Œ`promise`è·å¾—äº†å·²è§£ææ•°æ®çš„å€¼ã€‚
æˆ‘ä»¬ä¸å…³å¿ƒæ•´ä¸ª promise å¯¹è±¡ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒ data çš„å€¼ã€‚æœ‰ä¸€äº›å†…ç½®çš„æ–¹æ³•å¯ä»¥è·å– promise çš„å€¼ï¼Œå¯¹äºä¸€ä¸ª promise ï¼Œæˆ‘ä»¬å¯ä»¥é™„ä¸Šä¸‰ç§æ–¹æ³•ï¼š

- `.then()`ï¼šåœ¨ promise è§£æåè°ƒç”¨ã€‚
- `.catch()`ï¼šåœ¨ promise æ‹’ç»åè°ƒç”¨ã€‚
- `.finally()`ï¼šæ— è®º promise æ˜¯è§£æäº†è¿˜æ˜¯æ‹’ç»äº†ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½ä¼šè°ƒç”¨ã€‚
- `Promise.race()`ï¼šä¼ å…¥ä¸€ä¸ªå…ƒç´ ä¸º Promise å®ä¾‹çš„æ•°ç»„ï¼Œè°å…ˆè§£æäº†è°å…ˆè°ƒç”¨.then é‡Œçš„å›è°ƒå‡½æ•°ã€‚
- `Promise.all()`ï¼šä¼ å…¥ä¸€ä¸ªå…ƒç´ ä¸º Promise å®ä¾‹çš„æ•°ç»„ï¼Œæ•°ç»„å†…çš„ Promise å®ä¾‹å…¨éƒ¨å…ˆè§£ææ‰è°ƒç”¨.then é‡Œçš„å›è°ƒå‡½æ•°ã€‚

{% asset_img code9.png %}
`.then`æ–¹æ³•é€šè¿‡`resolve`æ–¹æ³•æ”¶åˆ°æ•°å€¼ã€‚

{% asset_img code10.gif %}

`.catch`æ–¹æ³•é€šè¿‡`rejected`æ–¹æ³•æ”¶åˆ°æ•°å€¼ã€‚

{% asset_img code11.gif %}

`Promise.race()`çš„ä½¿ç”¨æ–¹æ³•ï¼š

```js
const promise1 = new Promise((resolve, rejected) => {
  setTimeout(() => {
    console.log("promise1");
    resolve("a");
  }, 1000);
});
const promise2 = new Promise((resolve, rejected) => {
  setTimeout(() => {
    console.log("promise2");
    resolve();
  }, 1500);
});
const promise3 = new Promise((resolve, rejected) => {
  setTimeout(() => {
    console.log("promise3");
    resolve();
  }, 2000);
});
Promise.race([promise1, promise2, promise3]).then(() => {
  console.log(0);
});
```

æ‰“å°ç»“æœï¼š

promise1

0

promise2

promise3

`Promise.all()`çš„ä½¿ç”¨æ–¹æ³•ï¼š

```js
// ...
Promise.all([promise1, promise2, promise3]).then(() => {
  console.log(1);
});
```

æ‰“å°ç»“æœï¼š

promise1

promise2

promise3

0

---

å½“æˆ‘ä»¬çŸ¥é“ä¸€ä¸ª promise é€šå¸¸ä¼š resolve æˆ– reject ï¼Œä½ å¯ä»¥å†™æˆ`Promise.resolve`æˆ–`Promise.reject`ï¼š

{% asset_img code12.png %}

ä½ å°†åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­çœ‹åˆ°è¿™ç§å†™æ³• ğŸ˜„
åœ¨`getImage`çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆä¸å¾—ä¸åµŒå¥—å¤šä¸ªå›è°ƒæ‰èƒ½è¿è¡Œå®ƒä»¬ã€‚å¹¸è¿çš„æ˜¯ï¼Œ`then`å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ”¹å˜è¿™ä¸ªå±€é¢ï¼ğŸ¥³
`then`çš„ç»“æœæœ¬èº«å°±æ˜¯ promise çš„å€¼ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é“¾æ¥ä»»æ„å¤šçš„`.then`ï¼šä¸Šä¸€ä¸ª then å›è°ƒçš„ç»“æœå°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then å›è°ƒï¼

{% asset_img code13.png %}

çœŸæ£’ï¼è¿™ä¸ªè¯­æ³•å·²ç»æ¯”åµŒå¥—çš„å›è°ƒçœ‹èµ·æ¥å¥½å¤šäº†ã€‚

---

## å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

å¥½äº†ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•åˆ›å»º promise ä»¥åŠå¦‚ä½•ä» promise ä¸­æå–å€¼ã€‚è®©æˆ‘ä»¬æ·»åŠ æ›´å¤šçš„ä»£ç åˆ°è„šæœ¬ï¼Œå¹¶å†æ¬¡è¿è¡Œï¼š

{% asset_img code14.gif %}

ç­‰ç­‰ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ğŸ¤¯ å…ˆæ˜¯`Start!`è¢«æ‰“å°å‡ºæ¥äº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`console.log('Start!')`åœ¨ç¬¬ä¸€è¡Œã€‚ç¬¬äºŒä¸ªè¢«æ‰“å°çš„å€¼å´æ˜¯`End!`ï¼Œè€Œä¸æ˜¯ promise è§£æåçš„å€¼ï¼åªæœ‰åœ¨`End!`æ‰“å°å‡ºæ¥åï¼Œpromise çš„å€¼æ‰è¢«æ‰“å°å‡ºæ¥ã€‚è¿™å…¶ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ
æˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº† promise çš„çœŸæ­£åŠ›é‡ï¼ğŸš€ è™½ç„¶ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡`Promise`æ·»åŠ å¼‚æ­¥çš„è¡Œä¸ºï¼
å®é™…ä¸Šåœ¨äº‹ä»¶å¾ªç¯æœºåˆ¶ä¸­æœ‰ä¸¤ç§é˜Ÿåˆ—ï¼šå®é˜Ÿåˆ—ï¼ˆæˆ–ç§°ä½œä»»åŠ¡é˜Ÿåˆ—ï¼‰å’Œå¾®é˜Ÿåˆ—ã€‚å®ä»»åŠ¡é˜Ÿåˆ—ç”¨äºå®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ç”¨äºå¾®ä»»åŠ¡ã€‚
é‚£ä¹ˆä»€ä¹ˆæ˜¯å®ä»»åŠ¡ä»€ä¹ˆæ˜¯å¾®ä»»åŠ¡å‘¢ï¼Ÿæœ€å¸¸è§æœ‰ä»¥ä¸‹å‡ ç§ï¼š

{% asset_img å®ä»»åŠ¡.png %}

{% asset_img å¾®ä»»åŠ¡.png %}

å•Šï¼Œæˆ‘ä»¬åœ¨å¾®ä»»åŠ¡åˆ—è¡¨ä¸­çœ‹åˆ°äº†`Promise`ï¼ğŸ˜ƒ å½“ä¸€ä¸ª`Promise` è§£æåè°ƒç”¨å®ƒçš„`then()`,`catch()`æˆ–`finally()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­çš„å›è°ƒå°†è¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼è¿™æ„å‘³ç€`then()`ã€`catch()`æˆ–`finally()`æ–¹æ³•ä¸­çš„å›è°ƒä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè¿™å®é™…ä¸Šæ˜¯åœ¨ JavaScript ä»£ç ä¸­æ·»åŠ äº†ä¸€äº›å¼‚æ­¥è¡Œä¸ºï¼ é‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ‰§è¡Œ`then()`ã€`catch()`æˆ–`finally()`çš„å›è°ƒå‘¢ï¼Ÿäº‹ä»¶å¾ªç¯ç»™äº†ä»»åŠ¡ä¸åŒçš„ä¼˜å…ˆçº§:

1. å½“å‰åœ¨è°ƒç”¨å †æ ˆä¸­çš„æ‰€æœ‰å‡½æ•°å°†è¢«æ‰§è¡Œã€‚å½“å®ƒä»¬è¿”å›ä¸€ä¸ªå€¼æ—¶ï¼Œå°±ä¼šä»å †æ ˆä¸­å¼¹å‡ºã€‚
2. å½“è°ƒç”¨å †æ ˆä¸ºç©ºæ—¶ï¼Œæ‰€æœ‰æ’é˜Ÿçš„å¾®ä»»åŠ¡å°†ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆå¹¶æ‰§è¡Œï¼(å¾®ä»»åŠ¡è‡ªèº«ä¹Ÿå¯ä»¥è¿”å›æ–°çš„å¾®ä»»åŠ¡ï¼Œæœ‰æ•ˆåœ°åˆ›é€ ä¸€ä¸ªæ— é™å¾®ä»»åŠ¡å¾ªç¯ ğŸ˜¬)
3. å¦‚æœè°ƒç”¨å †æ ˆå’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©ºï¼Œåˆ™äº‹ä»¶å¾ªç¯æ£€æŸ¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸Šæ˜¯å¦è¿˜æœ‰ä»»åŠ¡ã€‚ä»»åŠ¡è¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸Šï¼Œæ‰§è¡Œï¼Œç„¶åå¼¹å‡º!
   è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­:

- Task1ï¼šç«‹å³è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆçš„å‡½æ•°ï¼Œä¾‹å¦‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ç«‹å³è°ƒç”¨å®ƒã€‚

- Task2, Task3, Task4ï¼šå¾®ä»»åŠ¡ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ª promise çš„`then`ä¸­çš„å›è°ƒå‡½æ•°ï¼Œæˆ–ä¸€ä¸ªè¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚

- Task5, Task6ï¼šä¸€ä¸ªå®ä»»åŠ¡ï¼Œä¾‹å¦‚`setTimeout`ã€`setImmediate`çš„å›è°ƒ

  {% asset_img code15.gif %}

  é¦–å…ˆï¼ŒTask1 è¿”å›ä¸€ä¸ªå€¼å¹¶ä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºã€‚ç„¶åï¼Œå¼•æ“æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿçš„ä»»åŠ¡ã€‚ä¸€æ—¦æ‰€æœ‰ä»»åŠ¡éƒ½è¢«æ”¾åˆ°è°ƒç”¨å †æ ˆä¸­å¹¶å¼¹å‡ºï¼Œå¼•æ“å°±ä¼šæ£€æŸ¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸Šçš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¼šå¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œå¹¶åœ¨å®ƒä»¬è¿”å›äº†å€¼æ—¶å¼¹å‡ºã€‚

{% asset_img code16.png %}

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æœ‰å®ä»»åŠ¡`setTimeout`å’Œå¾®ä»»åŠ¡ promise çš„ `then()`å›è°ƒã€‚ä¸€æ—¦å¼•æ“åˆ°è¾¾`setTimeout`å‡½æ•°é‚£è¡Œï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°è¿è¡Œè¿™æ®µä»£ç ï¼Œçœ‹çœ‹è®°å½•äº†ä»€ä¹ˆ!

---

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†å±•ç¤ºè¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆçš„æ–¹æ³•ï¼Œä¾‹å¦‚`console.log`ï¼Œ`setTimeout`å’Œ`Promise`ç­‰ã€‚å®ƒä»¬æ˜¯å†…éƒ¨æ–¹æ³•ï¼Œå®é™…ä¸Šä¸ä¼šå‡ºç°åœ¨å †æ ˆè·Ÿè¸ªä¸­â€”â€”æ‰€ä»¥å¦‚æœä½ æ­£åœ¨ä½¿ç”¨è°ƒè¯•å™¨è€Œåœ¨ä»»ä½•åœ°æ–¹éƒ½çœ‹ä¸åˆ°å®ƒä»¬ï¼Œè¯·ä¸è¦æ‹…å¿ƒï¼å®ƒåªæ˜¯æ–¹ä¾¿åœ¨æ²¡æœ‰æ·»åŠ å¾ˆå¤šç¤ºä¾‹ä»£ç çš„æƒ…å†µä¸‹æ›´å®¹æ˜“åœ°è§£é‡Šè¿™ä¸ªæ¦‚å¿µ ğŸ™‚
åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œå¼•æ“é‡åˆ°äº†`console.log()`ã€‚å®ƒè¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œç„¶åæ‰“å°å€¼'Start!'ã€‚æ–¹æ³•ä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºï¼Œå¼•æ“ç»§ç»­è¿è¡Œã€‚

{% asset_img code17.gif %}

è¿™æ—¶å¼•æ“é‡åˆ°äº†è¢«è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºçš„`setTimeout`æ–¹æ³•ã€‚`setTimeout`æ–¹æ³•æ˜¯æµè§ˆå™¨çš„åŸç”Ÿæ–¹æ³•ï¼šå®ƒçš„å›è°ƒå‡½æ•°(`() => console.log('In timeout')`)å°†è¢«æ·»åŠ åˆ° Web API ä¸­ï¼Œç›´åˆ°è®¡æ—¶å™¨è®¡æ—¶å®Œæˆã€‚å°½ç®¡æˆ‘ä»¬ä¸ºå®šæ—¶å™¨æä¾›äº†ä¸º 0 çš„å€¼ï¼Œå›è°ƒä»ç„¶é¦–å…ˆè¢«æ¨åˆ° Web API ï¼Œä¹‹åå®ƒè¢«æ·»åŠ åˆ°å®ä»»åŠ¡é˜Ÿåˆ—ï¼š`setTimeout`æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼

{% asset_img code18.gif %}

æ¥ç€å¼•æ“é‡åˆ°äº†`Promise.resolve()`æ–¹æ³•ã€‚`Promise.resolve()`æ–¹æ³•è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œä¹‹åè§£æä¸ºå€¼'Promise!'ã€‚ç„¶åå®ƒçš„å›è°ƒå‡½æ•°`then`è¢«æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚

æ³¨æ„ï¼š.then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼ç©¿é€ã€‚

```js
Promise.resolve(1).then(2).then(Promise.resolve(3)).then(console.log); // 1
```

{% asset_img code19.gif %}

å¼•æ“æ¥ç€åˆé‡åˆ°äº†`console.log()`æ–¹æ³•ã€‚å®ƒä¼šç«‹å³è¢«æ·»åŠ åˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œç„¶åæ‰“å°'End!'åˆ°æ§åˆ¶å°ï¼Œå¼¹å‡ºè°ƒç”¨å †æ ˆï¼Œå¼•æ“ç»§ç»­è¿è¡Œã€‚

{% asset_img code20.gif %}

ç°åœ¨å¼•æ“çœ‹åˆ°è°ƒç”¨å †æ ˆæ˜¯ç©ºçš„ã€‚ç”±äºè°ƒç”¨å †æ ˆä¸ºç©ºï¼Œå®ƒå°†æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ’é˜Ÿçš„ä»»åŠ¡ï¼æ˜¯çš„ï¼Œæœ‰ï¼Œpromise `then`å›è°ƒæ­£åœ¨æ’é˜Ÿä¸­ï¼å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸Šï¼Œç„¶åæ‰“å° promise çš„è§£æå€¼ï¼š'Promise !'ã€‚

{% asset_img code21.gif %}

å¼•æ“çœ‹åˆ°è°ƒç”¨å †æ ˆæ˜¯ç©ºçš„ï¼Œå› æ­¤å®ƒå°†å†æ¬¡æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä»¥æŸ¥çœ‹ä»»åŠ¡æ˜¯å¦å·²è¿›å…¥è¯¥é˜Ÿåˆ—ã€‚å“¦ä¸ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½æ˜¯ç©ºçš„ã€‚
æ˜¯æ—¶å€™æ£€æŸ¥å®ä»»åŠ¡é˜Ÿåˆ—äº†ï¼š`setTimeout`å›è°ƒä»ç„¶åœ¨é‚£é‡Œç­‰å¾…ï¼`setTimeout`çš„å›è°ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆã€‚å›è°ƒå‡½æ•°è¿”å›`console.log`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰“å°äº†'In timeout!'ï¼Œæ¥ç€`setTimeout`å›è°ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆã€‚

{% asset_img code22.gif %}

ç»“æŸäº†ï¼ğŸ¥³ å¥½åƒæˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„è¾“å‡ºä¹Ÿæ²¡é‚£ä¹ˆæ„å¤–å˜›ã€‚

## Async/Await

ES7 å¼•å…¥äº†ä¸€ç§åœ¨ JavaScript ä¸­æ·»åŠ å¼‚æ­¥è¡Œä¸ºçš„æ–°æ–¹æ³•ï¼Œèƒ½æ›´å®¹æ˜“åœ°ä½¿ç”¨ promise ï¼é€šè¿‡å¼•å…¥ async å’Œ await å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºéšå¼è¿”å› promise çš„å¼‚æ­¥å‡½æ•°ã€‚æˆ‘ä»¬æ€ä¹ˆåšå‘¢ï¼Ÿ
åœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥ä½¿ç”¨`Promise`å¯¹è±¡æ˜¾å¼åœ°åˆ›å»º`Promise`ï¼Œæ— è®ºæ˜¯é€šè¿‡é”®å…¥`new Promise(() =>{})`ï¼Œè¿˜æ˜¯`Promise.resolve`ï¼Œæˆ–è€…`Promise.reject`ã€‚
æˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºéšå¼è¿”å›å¯¹è±¡çš„å¼‚æ­¥å‡½æ•°ï¼Œè€Œä¸æ˜¯æ˜¾å¼åœ°ä½¿ç”¨`Promise`å¯¹è±¡ï¼è¿™æ„å‘³ç€æˆ‘ä»¬ä¸å†éœ€è¦è‡ªå·±ç¼–å†™ä»»ä½•`Promise`å¯¹è±¡äº†ã€‚

{% asset_img async1.png %}

è™½ç„¶å¼‚æ­¥å‡½æ•°éšå¼è¿”å› promise è¿™ä¸€äº‹å®éå¸¸æ£’ï¼Œä½†å¼‚æ­¥å‡½æ•°çš„çœŸæ­£å¼ºå¤§ä¹‹å¤„å¯ä»¥åœ¨ä½¿ç”¨`await`å…³é”®å­—æ—¶ä½“ç°å‡ºæ¥ï¼é€šè¿‡`await`å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`await`ç­‰å¾…çš„å€¼è¿”å›å·²è§£æçš„ promise æ—¶æš‚åœå¼‚æ­¥å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å¾—åˆ°è¿™ä¸ªå·²è§£æçš„ promise çš„å€¼ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰å¯¹`then()`å›è°ƒæ‰€åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç­‰å¾…çš„ promise å€¼åˆ†é…å˜é‡ï¼
è®©æˆ‘ä»¬çœ‹çœ‹å½“æˆ‘ä»¬è¿è¡Œä¸‹é¢çš„ä»£ç å—æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå§ï¼š

{% asset_img async2.gif %}

è¿™å…¶ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

{% asset_img async3.gif %}

é¦–å…ˆï¼Œå¼•æ“é‡åˆ°ä¸€ä¸ª`console.log`ã€‚å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆï¼Œä¹‹åæ‰“å°äº†`Before function!`ã€‚

{% asset_img async4.gif %}

ç„¶åï¼Œè°ƒç”¨å¼‚æ­¥å‡½æ•°`myFunc()`ï¼Œä¹‹åè¿è¡Œ`myFunc`çš„å‡½æ•°ä½“ã€‚åœ¨å‡½æ•°ä½“çš„ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†å¦ä¸€ä¸ª`console.log`ï¼Œéšåæ‰“å°äº†`In function`ï¼å°†`console.log`æ·»åŠ åˆ°è°ƒç”¨å †æ ˆï¼Œæ‰“å°äº†å€¼åå¼¹å‡ºã€‚

{% asset_img async5.gif %}

å‡½æ•°ä½“ç»§ç»­è¢«æ‰§è¡Œï¼Œè¿™å°±åˆ°äº†ç¬¬äºŒè¡Œã€‚æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ª`await`å…³é”®å­—ï¼ğŸ‰
é¦–å…ˆï¼Œç­‰å¾…çš„å€¼è¢«æ‰§è¡Œï¼šåœ¨æ­¤ä¾‹ä¸­æ˜¯å‡½æ•°`one`ã€‚å®ƒè¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆå†…ï¼Œå¹¶æœ€ç»ˆè¿”å›ä¸€ä¸ªå·²è§£æçš„ promise ã€‚ promise è¢«è§£æå¹¶ä¸”`one`å‡½æ•°è¿”å›äº†å€¼ä¹‹åï¼Œå¼•æ“è¿™æ—¶é‡åˆ°äº†`await`å…³é”®å­—ã€‚
å½“é‡åˆ°`await`å…³é”®å­—æ—¶ï¼Œ`async`å‡½æ•°å°†è¢«æŒ‚èµ·ã€‚âœ‹ğŸ¼ å‡½æ•°ä½“å°±æš‚åœæ‰§è¡Œäº†ï¼Œå‰©ä¸‹çš„å¼‚æ­¥å‡½æ•°è¢«è¿è¡Œåœ¨å¾®ä»»åŠ¡æ ˆä¸­ï¼

{% asset_img async6.gif %}

ç°åœ¨å¼‚æ­¥å‡½æ•°`myFunc`åœ¨é‡åˆ°`await`å…³é”®å­—æ—¶è¢«æŒ‚èµ·ï¼Œå¼•æ“è·³å‡ºäº†å¼‚æ­¥å‡½æ•°å¹¶åœ¨è¯¥å‡½æ•°è¢«è°ƒç”¨çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ç»§ç»­æ‰§è¡Œä»£ç ï¼šåœ¨æœ¬ä¾‹ä¸­æ˜¯**å…¨å±€çš„æ‰§è¡Œä¸Šä¸‹æ–‡**ä¸­!ğŸƒğŸ½â€â™€ï¸

{% asset_img async7.gif %}

æœ€ååœ¨å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼Œæ²¡æœ‰éœ€è¦è¿è¡Œçš„ä»»ä½•ä»»åŠ¡äº†ï¼æ¥ç€äº‹ä»¶å¾ªç¯æ£€æŸ¥æ˜¯å¦æœ‰å¾®ä»»åŠ¡è¿˜åœ¨æ’é˜Ÿï¼šç¡®å®æœ‰ï¼åœ¨è§£æäº†`one.myFunc`çš„å€¼å¹¶å¼¹å›è°ƒç”¨æ ˆä¹‹åï¼Œå¼‚æ­¥`myFunc`å‡½æ•°è¿˜åœ¨æ’é˜Ÿã€‚myFunc è¢«å¼¹å‡ºåˆ°è°ƒç”¨å †æ ˆä¸Šï¼Œå¹¶åœ¨å…ˆå‰åœæ­¢çš„åœ°æ–¹ç»§ç»­è¿è¡Œã€‚
å˜é‡`res`æœ€ç»ˆè·å¾—å®ƒçš„å€¼ï¼Œå³`one`å‡½æ•°è¿”å›çš„å·²è§£æ promise çš„å€¼ï¼æˆ‘ä»¬ç”¨`console.log`æ‰“å°å‡º`res`çš„å€¼ï¼š'One!'ã€‚'One!'è¢«æ‰“å°åˆ°åˆ°æ§åˆ¶å°ä¸­å¹¶å¼¹å‡ºè°ƒç”¨å †æ ˆï¼ğŸ˜Š

è¿™å°±å®Œäº‹äº†ï¼ä½ æ³¨æ„åˆ°`async`å‡½æ•°ä¸ promise çš„`then`çš„ä¸åŒä¹‹å¤„äº†å—ï¼Ÿ`await`å…³é”®å­—å°†æŒ‚èµ·`async`å‡½æ•°ï¼Œè€Œå½“æˆ‘ä»¬ä½¿ç”¨ then æ—¶ï¼Œ`Promise`ä½“å°†ç»§ç»­æ‰§è¡Œï¼

# ä¸€äº›é¢å¤–çš„ç»†èŠ‚

1ï¼‰async promise è°å…ˆæ‰§è¡Œï¼Ÿ

```js
async function async1() {
  await async2();
  console.log(" async1 end ");
}
```

åœ¨ Chrome 73 ä¹‹å‰ï¼Œé‡åˆ° await ä¼šè¢«è§£ææˆè¿™æ ·ï¼š

```js
async function async1() {
  return new Promise((resolve) => {
    Promise.resolve().then(() => {
      async2().then(resolve);
    });
  }).then(() => {
    console.log("async1 end ");
  });
}
```

åœ¨ Chrome 73 ä¹‹åï¼Œé‡åˆ° await ä¼šè¢«è§£ææˆè¿™æ ·ï¼š

```js
async function async1() {
  async2().then(() => {
    console.log("async1 end ");
  });
}
```

æ‰€ä»¥æµè§ˆå™¨çš„ç‰ˆæœ¬å¯èƒ½ä¼šå½±å“ promise å’Œ async-await çš„æ‰§è¡Œç»“æœï¼

2ï¼‰é‡åˆ°ä¸ç¡®å®šä»€ä¹ˆæ—¶å€™èƒ½ return çš„æƒ…å†µä¸‹ï¼Œè¯¥ä»»åŠ¡ä¼šåœ¨ Web API ä¸­è¢«æŒ‚èµ·ï¼Œå…ˆå¾€ä¸‹æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°æœ‰è¿”å›å€¼äº†æ‰å°† then ä¸­çš„å›è°ƒå‡½æ•°æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚

```js
axios.get("http://192.168.0.183:8200/fe/menu").then(() => {
  console.log(9);
});
setTimeout(() => {
  console.log(0);
}, 0);
```
